name: Ping staging cron endpoints

on:
  schedule:
    # Runs every 5 minutes (GitHub Actions uses UTC)
    - cron: "*/5 * * * *"
  workflow_dispatch:
    inputs:
      path:
        description: "Optional single path to ping (overrides defaults)"
        required: false
        default: ""

permissions:
  contents: read

concurrency:
  group: ping-staging
  cancel-in-progress: false

jobs:
  ping:
    runs-on: ubuntu-latest
    env:
      STAGING_URL: ${{ secrets.STAGING_URL }}
      CRON_SECRET: ${{ secrets.CRON_SECRET }}
      # Default endpoints we’ll try; first one wins, others are fallbacks.
      DEFAULT_ENDPOINTS: |
        /.netlify/functions/expire-holds
        /api/ops/expire-holds
    steps:
      - name: Validate inputs
        run: |
          set -e
          [ -n "$STAGING_URL" ] || { echo "Missing STAGING_URL secret"; exit 1; }
          [ -n "$CRON_SECRET" ] || { echo "Missing CRON_SECRET secret"; exit 1; }
          echo "Target: $STAGING_URL"

      - name: Choose endpoints (manual override if provided)
        id: choose
        shell: bash
        run: |
          if [ -n "${{ github.event.inputs.path }}" ]; then
            echo "endpoints=${{ github.event.inputs.path }}" >> "$GITHUB_OUTPUT"
          else
            # Use the newline list from DEFAULT_ENDPOINTS
            echo "endpoints<<EOF" >> "$GITHUB_OUTPUT"
            echo "$DEFAULT_ENDPOINTS" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          fi

      - name: Ping endpoints
        shell: bash
        run: |
          set -euo pipefail
          IFS=$'\n' read -rd '' -a PATHS <<< "${{ steps.choose.outputs.endpoints }}" || true

          if [ "${#PATHS[@]}" -eq 0 ]; then
            echo "No endpoints to ping"; exit 1
          fi

          failures=0
          for p in "${PATHS[@]}"; do
            # Trim spaces
            p="$(echo "$p" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
            [ -n "$p" ] || continue

            url="${STAGING_URL%/}${p}"
            echo "→ PING $url"
            # Send x-cron-secret header; capture body for diagnostics without exposing secrets
            http_code=$(curl -sS -o /tmp/resp.txt -w "%{http_code}" \
              -H "x-cron-secret: $CRON_SECRET" \
              --max-time 20 --retry 1 --retry-delay 2 "$url") || http_code=$?

            # Accept any 2xx as success
            if [[ "$http_code" =~ ^2[0-9]{2}$ ]]; then
              echo "  OK ($http_code)"
              cat /tmp/resp.txt | sed -e 's/.*/  body: &/' | head -n 5
              exit 0
            else
              echo "  WARN ($http_code) trying $p"
              cat /tmp/resp.txt | sed -e 's/.*/  body: &/' | head -n 10
              failures=$((failures+1))
            fi
          done

          echo "All candidates failed ($failures)."
          exit 1
