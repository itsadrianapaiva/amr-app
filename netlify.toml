[build]
  command = "next build"
  publish = ".next"

[[plugins]]
  package = "@netlify/plugin-nextjs"

[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"
  external_node_modules = ["@prisma/client"]
  included_files = ["prisma/schema.prisma"]

[dev]
  framework = "next"
  port = 8888
  autoLaunch = false

# ---- Context-specific environment (safe, non-secret values) ----
[context.production.environment]
  # TIP: DEPLOY_PRIME_URL already includes https:// — don't prefix it.
  APP_URL = "$URL"
  NEXT_PUBLIC_APP_URL = "$URL"

[context.branch-deploy.environment]
  # Use Netlify's computed URL for branch deploys (already includes https://)
  APP_URL = "$DEPLOY_PRIME_URL"
  NEXT_PUBLIC_APP_URL = "$DEPLOY_PRIME_URL"

[context.deploy-preview.environment]
  APP_URL = "$DEPLOY_PRIME_URL"
  NEXT_PUBLIC_APP_URL = "$DEPLOY_PRIME_URL"

# --- Build commands per context (with sanity check) ---
[context.production]
  command = '''node -e "try{const u=new URL(process.env.DATABASE_URL||'');const d=process.env.DIRECT_URL?new URL(process.env.DIRECT_URL):{protocol:'(missing)'};console.log('Sanity ▶ DB:',u.protocol,'DIRECT:',d.protocol)}catch(e){console.log('Sanity ▶',e.message)}" && npx prisma migrate deploy && next build'''

[context.branch-deploy]
  command = '''node -e "try{const u=new URL(process.env.DATABASE_URL||'');const d=process.env.DIRECT_URL?new URL(process.env.DIRECT_URL):{protocol:'(missing)'};console.log('Sanity ▶ DB:',u.protocol,'DIRECT:',d.protocol)}catch(e){console.log('Sanity ▶',e.message)}" && npx prisma migrate deploy && next build'''

[context.deploy-preview]
  # Keep previews simple (build only). If you want migrations here too, use the same command as above.
  command = "next build"