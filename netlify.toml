[build]
  command = "next build"
  publish = ".next"

[[plugins]]
  package = "@netlify/plugin-nextjs"

[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"
  external_node_modules = ["@prisma/client"]
  included_files = ["prisma/schema.prisma"]

[dev]
  framework = "next"
  port = 8888
  autoLaunch = false

# ---- Non-secret env per context (let Netlify provide full URLs) ----
[context.production.environment]
  APP_URL = "$URL"
  NEXT_PUBLIC_APP_URL = "$URL"

[context.branch-deploy.environment]
  APP_URL = "$DEPLOY_PRIME_URL"
  NEXT_PUBLIC_APP_URL = "$DEPLOY_PRIME_URL"

[context.deploy-preview.environment]
  APP_URL = "$DEPLOY_PRIME_URL"
  NEXT_PUBLIC_APP_URL = "$DEPLOY_PRIME_URL"

# ---- Build commands per context ----
[context.production]
  # Ensure DB is migrated before building
  command = "npx prisma migrate deploy && next build"

[context.branch-deploy]
  # Same for staging branch deploys
  command = "npx prisma migrate deploy && next build"

[context.deploy-preview]
  # Keep previews simple. If you want migrations here too, copy the line above.
  command = "next build"

  [context."staging".environment]
  # Temporarily omit this key from the secrets scanner on the staging branch
  SECRETS_SCAN_OMIT_KEYS = "STRIPE_SECRET_KEY,CRON_SECRET"
