[build]
  # We still build to .next and let the Netlify Next.js plugin do its thing
  command = "next build"
  publish = ".next"

[[plugins]]
  package = "@netlify/plugin-nextjs"

[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"
  external_node_modules = ["@prisma/client"]
  included_files = [
    "prisma/schema.prisma",
    "node_modules/.prisma/client/**"
  ]

[dev]
  framework = "next"
  port = 8888
  autoLaunch = false

# -------------------------
# PRODUCTION CONTEXT
# -------------------------
[context.production]
  # In production we run migrations, then build
  command = "node scripts/netlify-build.js"

  [context.production.environment]
    APP_URL = "$URL"
    NEXT_PUBLIC_APP_URL = "$URL"
    RUN_MIGRATIONS = "1"

    OPS_DASHBOARD_ENABLED = "1"
    OPS_DISABLE_AUTH = "0"
    OPS_AUTH_DISABLED = "0"

  [[context.production.redirects]]
    from = "/*"
    to = "https://amr-rentals.com/:splat"
    status = 301
    force = true
    conditions = { Host = [
      "www.amr-rentals.com",
      "algarvemachinery.netlify.app"
    ] }

# -------------------------
# STAGING CONTEXT (branch: staging)
# -------------------------
[context."branch:staging"]
  # NOTE:
  # Netlify *does NOT apply environment variables* from this block
  # in this project. Verified through live testing.
  #
  # Redirects, commands, and ops settings DO apply.
  # Env vars MUST be set in [context.branch-deploy] to affect staging.
  #
  # Keeping this block for redirects + ops behavior ONLY.

  command = "node scripts/netlify-build.js"

  [context."branch:staging".environment]
    APP_URL = "$DEPLOY_PRIME_URL"
    NEXT_PUBLIC_APP_URL = "$DEPLOY_PRIME_URL"
    RUN_MIGRATIONS = "1"

    OPS_DASHBOARD_ENABLED = "1"
    OPS_DISABLE_AUTH = "0"
    OPS_AUTH_DISABLED = "0"

    SECRETS_SCAN_OMIT_KEYS = "STRIPE_SECRET_KEY"

    # Flags intentionally set to OFF here because this block does not apply env vars.
    NEXT_UNOPTIMIZED_IMAGES = "0"
    NEXT_PUBLIC_DISABLE_OPTIMIZED_IMAGES = "0"

  [[context."branch:staging".redirects]]
    from = "/*"
    to = "/:splat"
    status = 200

# -------------------------
# GENERIC BRANCH DEPLOYS (feature/* and staging)
# -------------------------
[context.branch-deploy]
  command = "next build"

  [context.branch-deploy.environment]
    APP_URL = "$DEPLOY_PRIME_URL"
    NEXT_PUBLIC_APP_URL = "$DEPLOY_PRIME_URL"
    RUN_MIGRATIONS = "0"

    OPS_DASHBOARD_ENABLED = "1"
    OPS_DISABLE_AUTH = "0"
    OPS_AUTH_DISABLED = "0"

    # -----------------------------------------------
    # IMPORTANT:
    # These flags MUST be defined here because this is
    # the ONLY context Netlify actually applies for the
    # staging branch (even though a staging context exists).
    #
    # Verified through testing:
    # - staging DOES NOT read [context."branch:staging"].environment
    # - staging DOES read [context.branch-deploy].environment
    #
    # This ensures staging and feature branches bypass Next Image optimizer.
    # -----------------------------------------------
    NEXT_UNOPTIMIZED_IMAGES = "1"
    NEXT_PUBLIC_DISABLE_OPTIMIZED_IMAGES = "1"

  [[context.branch-deploy.redirects]]
    from = "/*"
    to = "/:splat"
    status = 200
    force = true

# -------------------------
# DEPLOY PREVIEWS (PR previews)
# -------------------------
[context.deploy-preview]
  command = "next build"

  [context.deploy-preview.environment]
    APP_URL = "$DEPLOY_PRIME_URL"
    NEXT_PUBLIC_APP_URL = "$DEPLOY_PRIME_URL"
    RUN_MIGRATIONS = "0"

    OPS_DASHBOARD_ENABLED = "1"
    OPS_DISABLE_AUTH = "1"

# -------------------------
# GLOBAL HEADERS
# -------------------------
[[headers]]
  for = "/ops-admin/*"
  [headers.values]
    X-Robots-Tag = "noindex, nofollow, noarchive"
