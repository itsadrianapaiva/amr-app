
[build]
  command = "next build"
  publish = ".next"

[[plugins]]
  package = "@netlify/plugin-nextjs"

[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"
  external_node_modules = ["@prisma/client"]
  included_files = [
    "prisma/schema.prisma",
    "node_modules/.prisma/client/**"
  ]

[dev]
  framework = "next"
  port = 8888
  autoLaunch = false

   # ---- Force primary domain on production only ----
  [[context.production.redirects]]
    from = "/*"
    to = "https://amr-rentals.com/:splat"
    status = 301
    force = true
    conditions = { Host = [
      "www.amr-rentals.com",                 # www â†’ apex
      "algarvemachinery.netlify.app",        # site subdomain
    ] }

     [[context."branch:staging".redirects]]
    from = "/*"
    to = "/:splat"
    status = 200

# ---------- URLs per context ----------
[context.production.environment]
  APP_URL = "$URL"
  NEXT_PUBLIC_APP_URL = "$URL"
  RUN_MIGRATIONS = "1"
  # Ops ON in production (auth required)
  OPS_DASHBOARD_ENABLED = "1"
  OPS_DISABLE_AUTH = "0"
  OPS_AUTH_DISABLED = "0"

# Applies to any branch deploy (feature/*, bugfix/*, etc.)
[context.branch-deploy.environment]
  APP_URL = "$DEPLOY_PRIME_URL"
  NEXT_PUBLIC_APP_URL = "$DEPLOY_PRIME_URL"
  RUN_MIGRATIONS = "0"
  # Ops is enabled on staging (with auth)
  OPS_DASHBOARD_ENABLED = "1"
  OPS_DISABLE_AUTH = "0"
  OPS_AUTH_DISABLED = "0"

# Specific branch-only override: staging
# This is the correct syntax for a single branch context
[context."branch:staging".environment]
  RUN_MIGRATIONS = "1"
  # Example: temporarily omit a key from scanner on this one branch
  SECRETS_SCAN_OMIT_KEYS = "STRIPE_SECRET_KEY"
  # Ops is enabled on staging (with auth)
  OPS_DASHBOARD_ENABLED = "1"
  OPS_DISABLE_AUTH = "0"
  OPS_AUTH_DISABLED = "0"

[context.deploy-preview.environment]
  APP_URL = "$DEPLOY_PRIME_URL"
  NEXT_PUBLIC_APP_URL = "$DEPLOY_PRIME_URL"
  RUN_MIGRATIONS = "0"
  # Optional: previews can show Ops; auth can be disabled for fast smoke
  OPS_DASHBOARD_ENABLED = "1"
  OPS_DISABLE_AUTH = "1"

# ---------- Build commands per context ----------
# Production: run migrations, then build
[context.production]
  command = "node scripts/netlify-build.js"

# Staging branch: run migrations, then build
# Prevent production redirect from affecting branch deploys
[context."branch:staging"]
  command = "node scripts/netlify-build.js"
  # Do NOT include redirects; staging must stay isolated


# All other branch deploys: build only
[context.branch-deploy]
  command = "next build"

# Deploy previews: build only
[context.deploy-preview]
  command = "next build"

  # ---------- Global headers ----------
# Prevent indexing of any /ops URLs across all contexts
[[headers]]
  for = "/ops-admin/*"
  [headers.values]
    X-Robots-Tag = "noindex, nofollow, noarchive"