[build]
  # We still build to .next and let the Netlify Next.js plugin do its thing
  command = "next build"
  publish = ".next"

[[plugins]]
  package = "@netlify/plugin-nextjs"

[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"
  external_node_modules = ["@prisma/client"]
  included_files = [
    "prisma/schema.prisma",
    "node_modules/.prisma/client/**"
  ]

[dev]
  framework = "next"
  port = 8888
  autoLaunch = false

# -------------------------
# PRODUCTION CONTEXT
# -------------------------
[context.production]
  # In production we run migrations, then build (and emit staging headers script won't run here)
  command = "node scripts/netlify-build.js"

  # Environment for production
  [context.production.environment]
    APP_URL = "$URL"
    NEXT_PUBLIC_APP_URL = "$URL"
    RUN_MIGRATIONS = "1"

    # Ops ON in production (auth required)
    OPS_DASHBOARD_ENABLED = "1"
    OPS_DISABLE_AUTH = "0"
    OPS_AUTH_DISABLED = "0"

  # Force canonical domain in production ONLY
  [[context.production.redirects]]
    from = "/*"
    to = "https://amr-rentals.com/:splat"
    status = 301
    force = true
    # Only match real prod-ish hosts. Do NOT include branch deploy hosts.
    conditions = { Host = [
      "www.amr-rentals.com",
      "algarvemachinery.netlify.app"
    ] }

# -------------------------
# STAGING CONTEXT (branch: staging)
# -------------------------
[context."branch:staging"]
  # Staging also runs migrations then build
  command = "node scripts/netlify-build.js"

  [context."branch:staging".environment]
    # In staging we want branch URL as app URL
    APP_URL = "$DEPLOY_PRIME_URL"
    NEXT_PUBLIC_APP_URL = "$DEPLOY_PRIME_URL"
    RUN_MIGRATIONS = "1"

    # Ops enabled WITH auth on staging
    OPS_DASHBOARD_ENABLED = "1"
    OPS_DISABLE_AUTH = "0"
    OPS_AUTH_DISABLED = "0"

    # Example: temporarily omit a key from scanner on this one branch
    SECRETS_SCAN_OMIT_KEYS = "STRIPE_SECRET_KEY"

    # Staging hotfix: disable Next image optimizer (images serve directly from /images/...)
    NEXT_UNOPTIMIZED_IMAGES = "1"
    NEXT_PUBLIC_DISABLE_OPTIMIZED_IMAGES = "1"

  # Hard override: NEVER redirect branch deploy traffic to production
  # This short-circuits any other redirect rule for this context.
  [[context."branch:staging".redirects]]
    from = "/*"
    to = "/:splat"
    status = 200

# -------------------------
# GENERIC BRANCH DEPLOYS (feature/* etc)
# -------------------------
[context.branch-deploy]
  command = "next build"

  [context.branch-deploy.environment]
    APP_URL = "$DEPLOY_PRIME_URL"
    NEXT_PUBLIC_APP_URL = "$DEPLOY_PRIME_URL"
    RUN_MIGRATIONS = "0"

    # Ops enabled with auth (same behavior as staging unless overridden)
    OPS_DASHBOARD_ENABLED = "1"
    OPS_DISABLE_AUTH = "0"
    OPS_AUTH_DISABLED = "0"

     # Staging hotfix: disable Next image optimizer (images serve directly from /images/...)
    NEXT_UNOPTIMIZED_IMAGES = "1"
    NEXT_PUBLIC_DISABLE_OPTIMIZED_IMAGES = "1"

    # HARD STOP: never send branch deploys to production
  [[context.branch-deploy.redirects]]
    from = "/*"
    to = "/:splat"
    status = 200
    force = true

# -------------------------
# DEPLOY PREVIEWS (PR previews)
# -------------------------
[context.deploy-preview]
  command = "next build"

  [context.deploy-preview.environment]
    APP_URL = "$DEPLOY_PRIME_URL"
    NEXT_PUBLIC_APP_URL = "$DEPLOY_PRIME_URL"
    RUN_MIGRATIONS = "0"

    # Preview env can bypass ops auth for quick smoke
    OPS_DASHBOARD_ENABLED = "1"
    OPS_DISABLE_AUTH = "1"

# -------------------------
# GLOBAL HEADERS
# -------------------------
# Prevent indexing of any /ops URLs in any environment
[[headers]]
  for = "/ops-admin/*"
  [headers.values]
    X-Robots-Tag = "noindex, nofollow, noarchive"
