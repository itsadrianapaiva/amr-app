generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url       = env("DATABASE_URL")   // runtime (Accelerate ok)
  directUrl = env("DIRECT_URL")     // migrations use direct Postgres
}

model Machine {
  id             Int       @id @default(autoincrement())
  name           String    @unique
  description    String
  
  /// Deprecated for rendering; we now use curated local assets.
  /// Keep for compatibility until we fully remove usages.
  imageUrl       String

  /// Reference-only link to the exact model (CSV "Image" column).
  /// Not rendered in the UI; for Ops/context.
  referenceUrl   String?
  dailyRate      Decimal
  weight         String
  deposit        Decimal
  deliveryCharge Decimal?
  minDays        Int       @default(1)
  pickupCharge   Decimal?

  /// Renamed in Prisma to 'category' but still mapped to the existing DB column 'type'.
  category       String    @default("Uncategorized") @map("type")

 /// Optional machine model (e.g., "Bobcat E35", "CAT 259D3")
  model          String?
  bookings       Booking[]
}

model Booking {
  id                         Int                     @id @default(autoincrement())
  machineId                  Int
  machine                    Machine                 @relation(fields: [machineId], references: [id])

  startDate                  DateTime
  endDate                    DateTime
  holdExpiresAt              DateTime?               @db.Timestamp(6)

  status                     BookingStatus           @default(PENDING)

  customerName               String
  customerEmail              String
  customerPhone              String

  totalCost                  Decimal
  /// Temporarily reused to mean "fully paid" after the pivot.
  /// (Optional: rename to `paid` in a later migration.)
  depositPaid           Boolean          @default(false)

  /// PI for the successful full payment (card/MB WAY/SEPA once confirmed).
  stripePaymentIntentId String?          @unique

  customerNIF                String?

  insuranceSelected          Boolean                 @default(true)
  deliverySelected           Boolean                 @default(true)
  pickupSelected             Boolean                 @default(true)

  billingAddressLine1        String?
  billingCity                String?
  billingCompanyName         String?
  billingCountry             String?
  billingIsBusiness          Boolean                 @default(false)
  billingPostalCode          String?
  billingTaxId               String?

  operatorSelected           Boolean                 @default(false)

  siteAddressCity            String?
  /// Operational site address (NOT for invoicing)
  siteAddressLine1           String?
  siteAddressNotes           String?
  siteAddressPostalCode      String?

  during                     Unsupported("tsrange")? @default(dbgenerated("tsrange(\"startDate\", \"endDate\", '[]'::text)"))
  
  createdAt                  DateTime                @default(now())
  updatedAt                  DateTime                @updatedAt
  
 // Invoicing persistence (MVP) 
  /// e.g., "vendus" for now; keeps door open to swap providers later.
  invoiceProvider            String?
  /// Providerâ€™s internal document ID (stringified); paired with provider for uniqueness.
  invoiceProviderId          String?
  /// Human-facing document number (e.g., "FT 2025/123").
  invoiceNumber              String?
  /// Public HTTPS link to the PDF (as returned by provider).
  invoicePdfUrl              String?
  /// ATCUD (if the series has a validation code configured).
  invoiceAtcud               String?

  @@unique([invoiceProvider, invoiceProviderId])
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
}